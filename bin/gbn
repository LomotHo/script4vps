#!/bin/bash
set -e

# 初始化变量
disable_push=false

# 显示帮助信息
show_help() {
    echo "用法: $0 <branch_name> [--disable-push]"
    echo "选项:"
    echo "  --disable-push    不自动推送到远程"
    echo "  -h, --help       显示此帮助信息"
}

# 解析命令行参数
branch_name=""
while [[ $# -gt 0 ]]; do
    case $1 in
    --disable-push)
        disable_push=true
        shift
        ;;
    -h | --help)
        show_help
        exit 0
        ;;
    *)
        if [ -z "$branch_name" ]; then
            branch_name="$1"
        else
            echo "错误: 未知的选项 $1"
            show_help
            exit 1
        fi
        shift
        ;;
    esac
done

# 检查分支名称是否提供
if [ -z "$branch_name" ]; then
    echo "错误: 必须提供分支名称"
    show_help
    exit 1
fi

# 检查当前分支
current_branch=$(git branch --show-current)
if [ "$current_branch" != 'main' ] && [ "$current_branch" != 'master' ] && [ "$current_branch" != 'dev' ]; then
    echo "错误: 只能在 main 或 master 或 dev 分支上执行此命令"
    exit 1
fi

# Sanitize branch name
sanitized_branch=$(echo "$branch_name" | sed 's/:/\//g' | sed 's/ /-/g')
commit_line=$(echo "$branch_name" | sed 's/\//:/g' | sed 's/-/ /g')

git switch -c "$sanitized_branch"
git add .
git commit -am "$commit_line"

if [ "$disable_push" = false ]; then
    git push --set-upstream origin "$sanitized_branch"
fi
